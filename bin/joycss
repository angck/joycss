#!/usr/bin/env node

var argv   = process.argv.slice(1);
var path   = require('path');
var fs     = require('fs');
var argu   = [];
var util   = require('util');
var exists = fs.existsSync || path.existsSync;

argv.forEach(function(arg){
  if (arg[0] === '-' && arg.length > 2 && 
    arg !== '--config' && arg !== '--update' ){

    for (var i = 1; i < arg.length; i++) {
      argu.push('-' + arg[i]);
    }
  } else {
    argu.push(arg);
  }
});

if (argu.length === 1){
  //如果没有输入任何信息
  argu.push('-h');
}
var config = {
  file: '',
  //布局方式
  layout: 'auto'
};

var args = argu.filter(function(arg){
  var match = arg.match(/^--?([a-z][0-9a-z-]*)(?:=([^\s]+))?$/i);
  if (match) { 
    arg = match[1];
  } else { 
    return arg;
  }

  switch (arg) {
    case 'h':
    case 'help': {
      var help = fs.readFileSync(__dirname + '/help.txt');
      var version = fs.readFileSync(path.resolve(__dirname, '../package.json'));
      version = JSON.parse(version).version;
      console.log(help.toString().replace('{version}', version).
        replace('{filename}', __filename));
      process.exit(0);
    }

    case 'y':
    case 'vertical': {
      console.log('use layout vertical');
      config.layout = 'vertical';
      break;
    }

    case 'x':
    case 'horizontal': {
      config.layout = 'horizontal';
      break;
    }

    //全部使用紧凑拼图
    case 'c':
    case 'close': {
      console.log('use layout close');
      config.layout = 'close';
      break;
    }

    //使用png24
    case 'a':
    case 'alpha': {
      console.log('use alpha mode, sprite image will be truecolor image, eg:png24');
      config.force8bit = false;
      break;
    }

    //背景白色
    case 'w':
    case 'white': {
      console.log('use white background for sprite image, no transpant');
      config.background = 'ffffff00';
      break;
    }

    //重写文件名,使用source文件
    case 's':
    case 'source': {
      console.log('rewrite css file, use .source.css file as input');
      config.writeFile = true;
      break;
    }

    //图片上传
    case 'u':
    case 'upload': {
      console.log('upload image file an sprite finish');
      config.uploadFile = true;
      break;
    }

    //重写文件名,使用source文件
    case 'i':
    case 'important': {
      console.log('add important for sprite rule, improve background-image level');
      config.useImportant = true;
      break;
    }

    case 'n':
    case 'nochange':{
      console.log('nochange for sprite image, use the backup url');
      config.nochange = true;
      break;
    }

    case 'v':
    case 'version': {
      var version = fs.readFileSync(path.resolve(__dirname, '../package.json'));
      version = JSON.parse(version).version;
      console.log("v" + version);
      process.exit(0);
    }

    case 'config': {
      var json = 'upload.json';
      var configFile = path.resolve(process.cwd(), json);
      var dest = path.resolve(__dirname, '../' + json);
      if (exists(configFile)){
        var fileData = fs.readFileSync(configFile);
        fs.writeFileSync(dest, fileData);
        console.log('config file copy success!');
      } else {
        console.log('the upload.json file is not exists!');
      }
      process.exit(0);
    }
  }
});


config.file = args[1];

if (!exists(config.file)){
  console.log('no css file input or you file is not exists!');
} else {
  config.file = path.resolve(process.cwd(), config.file);
  var parser = require('../src/spriteDef');

  debugger;
  new parser(config);
}

/**
 * vim: ft=javascript:tw=80:
 */
